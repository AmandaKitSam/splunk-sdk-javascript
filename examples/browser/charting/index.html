<!DOCTYPE html>
<html>
  <head>
    <title>Splunk Charting</title>
    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
    <script type="text/javascript" src="../../../client/splunk.js"></script>
    <script>
    
      $(function() {
        var Async = Splunk.Async;

        var http = new Splunk.ProxyHttp("/proxy");
        svc = new Splunk.Client.Service(http, { 
          scheme: "https",
          host: "Octavian2.local",
          port: "8089",
          username: "admin",
          password: "changeme"
        });
        
        var chartToken = Splunk.UI.loadCharting("../../../client/splunk.ui.charting.js", function() {
          // Once we have the charting code, create a chart and update it.
          chart = new Splunk.UI.Charting.Chart($("#chart-container"), Splunk.UI.Charting.ChartType.COLUMN, false);
        });
        var chart = null; 
        
        var searchTerm = 'search index=_internal | head 1000 | stats count(host), count(source) by sourcetype';
        Async.chain([
          // Login
          function(callback) { svc.login(callback); },
          // Create the job
          function(success, callback) {
            svc.jobs().create(searchTerm, {status_buckets: 300}, callback);
          },
          // Loop until the job is "done"
          function(job, callback) {
            var searcher = new Splunk.Searcher.JobManager(job.service, job);
            
            // Move forward once the search is done
            searcher.done(callback);
          },
          // Get the final results data
          function(searcher, callback) {
            searcher.job.results({json_mode: "column"}, callback);
          },
          // Update the chart
          function(results, job, callback) {  
            Splunk.UI.ready(chartToken, function() {
              chart.setData(results, {
                "chart.stackMode": "stacked"
              });
              chart.draw();
              callback(null, job);
            });
          }
        ],
        // And we're done, so make sure we had no error, and
        // cancel the job
        function(err, job) {
          if (err) {
            console.log(err);
            alert("An error occurred");
          }
          
          if (job) {
            job.cancel();
          }
        });
      });
    </script>
    
    <style>
      #chart-container {
      }
    </style>
  </head>
  <body>
    <div id="chart-container">
    
    </div>
  </body>
</html>