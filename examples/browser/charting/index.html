<!DOCTYPE html>
<html>
  <head>
    <title>Splunk Charting</title>
    
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
    <script type="text/javascript" src="../../../client/splunk.js"></script>
    <script>
    
      $(function() {
        var XdmHttp = Splunk.XdmHttp;
        var Async = Splunk.Async;

        svc = new Splunk.Client.Service({ 
            scheme: "https",
            host: "localhost",
            port: "8089",
            username: "itay",
            password: "changeme",
        });
        
        var chartToken = Splunk.UI.loadCharting("../../../client/splunk.ui.charting.js");
        var chart = null; 
        
        var searchTerm = 'search index=_internal | head 1000 | stats count(host), count(source) by sourcetype';
        Async.chain([
          function(callback) {
            Splunk.UI.ready(chartToken, function() {
              chart = new Splunk.UI.Charting.Chart($("#chart-container"), Splunk.UI.Charting.ChartType.COLUMN, false);
              callback();
            });
          },
          // Login
          function(callback) { svc.login(callback); },
          // Create the job
          function(success, callback) {
            svc.jobs().create(searchTerm, {status_buckets: 300}, callback);
          },
          // Loop until the job is "done"
          function(job, callback) {
            var searcher = new Splunk.Searcher.JobManager(job.service, job);
            
            // Move forward once the search is done
            searcher.done(callback);
          },
          // Get the final results data
          function(searcher, callback) {
            searcher.job.results({json_mode: "column"}, callback);
          },
          // Update the chart
          function(results, job, callback) {   
            chart.setData(results, {
              "chart.stackMode": "stacked"
            });
            chart.draw();
            callback(job);
          }
        ],
        // And we're done, so make sure we had no error, and
        // cancel the job
        function(job, err) {
          if (err) {
            console.log(err);
            throw new Error(err);
          }
          
          job.cancel();
        });
      });
    </script>
    
    <style>
      #chart-container {
      }
    </style>
  </head>
  <body>
    <div id="chart-container">
    
    </div>
  </body>
</html>