<!DOCTYPE html>
<html>
  <head>
    <title>Splunk Timeline</title>
    <link rel="stylesheet" type="text/css" href="timeline.css">
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.js"></script>
    <script type="text/javascript" src="../../../client/splunk.js"></script>
    <script>    
      $(function() {
        var timelineToken = Splunk.UI.loadTimeline("../../../client/splunk.ui.timeline.js", function() {
          timeline = new Splunk.UI.Timeline.Timeline($("#timeline-container"));
        });
        
        var Async = Splunk.Async;

        var http = new Splunk.ProxyHttp("/proxy");
        svc = new Splunk.Client.Service(http, { 
          scheme: "https",
          host: "localhost",
          port: "8089",
          username: "admin",
          password: "changeme",
        });
        
        var timeline = null;
        var searchTerm = "search * | head 10 | stats count";
        
        // A small utility function to queue up operations on the chart
        // until it is ready.
        var updateTimeline = function(data) {
          var setData = function() {
            timeline.updateWithJSON(data);
          }
          
          if (timeline === null) {
            Splunk.UI.ready(timelineToken, function() { setData(); });
          }
          else {
            setData();
          }
        }
        
        Async.chain([
          // Login
          function(callback) { svc.login(callback); },
          // Create the job
          function(success, callback) {
            svc.jobs().create(searchTerm, {status_buckets: 300}, callback);
          },
          // Loop until the job is "done"
          function(job, callback) {
            var searcher = new Splunk.Searcher.JobManager(job.service, job);
            
            // Queue up timeline displays while we are querying the job
            searcher.onProgress(function(properties) {
              job.timeline({}, function(err, data) { 
                if (!err) updateTimeline(data);
              });
            });
            
            // Move forward once the search is done
            searcher.done(callback);
          },
          // Get the final timeline data
          function(searcher, callback) {
            searcher.job.timeline({}, callback);
          },
          // Update the timeline control
          function(timelineData, job, callback) {
            updateTimeline(timelineData);
            callback(job);
          }
        ],
        // And we're done, so make sure we had no error, and
        // cancel the job
        function(job, err) {
          if (err) {
            console.log(err);
            throw new Error(err);
          }
          
          job.cancel();
        });
      });
    </script>
    
    <style>
      #timeline-container {
        height: 150px;
      }
    </style>
  </head>
  <body>
    <div id="timeline-container">
    
    </div>
  </body>
</html>